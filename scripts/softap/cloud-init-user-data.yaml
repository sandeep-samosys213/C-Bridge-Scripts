#cloud-config
# C-Bridge Cloud-Init Configuration

hostname: cbridge1

# -----------------------------
# Package setup
# -----------------------------
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - htop
  # vim removed - optional, can install later if needed

# -----------------------------
# Write required files
# -----------------------------
write_files:

  # First boot script
  - path: /usr/local/bin/cbridge-first-boot.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -e

      LOG_FILE="/var/log/cbridge-first-boot.log"
      STATE_FILE="/var/lib/cbridge/first-boot-complete"
      REPO_URL="https://raw.githubusercontent.com/sandeep-samosys213/C-Bridge-Scripts/refs/heads/main"  
      SETUP_SCRIPT_URL="$REPO_URL/setup_script"

      log() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
      }

      if [ -f "$STATE_FILE" ]; then
          log "First boot already completed. Skipping."
          exit 0
      fi

      log "=== C-Bridge First Boot Setup ==="

      mkdir -p /var/lib/cbridge
      mkdir -p "$(dirname "$LOG_FILE")"

      log "Waiting for network interface..."
      
      # Wait for network interface to be up (not necessarily internet)
      for i in {1..30}; do
          if ip link show eth0 | grep -q "state UP" || ip link show wlan0 | grep -q "state UP"; then
              log "Network interface ready"
              break
          fi
          sleep 2
      done
      
      # Try to get internet connectivity (optional - SoftAP can work without internet)
      log "Checking internet connectivity..."
      INTERNET_AVAILABLE=false
      for i in {1..10}; do
          if ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
              log "Internet connectivity available"
              INTERNET_AVAILABLE=true
              break
          fi
          sleep 2
      done
      
      if [ "$INTERNET_AVAILABLE" = "false" ]; then
          log "WARNING: No internet connectivity detected"
          log "This is OK - SoftAP will start for WiFi configuration"
          log "Setup script will continue - some features may require internet later"
      fi

      log "Downloading setup script and repository..."

      # Create app directory
      APP_DIR="/home/$USER/C-Bridge-Production"
      mkdir -p "$APP_DIR"
      cd "$APP_DIR"

      # Download setup script (retry logic for network issues)
      log "Downloading setup script from: $SETUP_SCRIPT_URL"
      DOWNLOAD_SUCCESS=false
      for attempt in {1..5}; do
          if curl -fsSL "$SETUP_SCRIPT_URL" -o setup_script; then
              DOWNLOAD_SUCCESS=true
              log "Setup script downloaded successfully"
              break
          else
              log "Download attempt $attempt failed, retrying in 5 seconds..."
              sleep 5
          fi
      done
      
      if [ "$DOWNLOAD_SUCCESS" = "false" ]; then
          log "ERROR: Failed to download setup script after 5 attempts"
          log "This may be due to network issues. SoftAP will still be available for WiFi configuration."
          log "You can manually download and run setup_script later via SSH"
          # Don't exit - allow SoftAP to start for WiFi configuration
          exit 0
      fi

      chmod +x setup_script

      # Download essential SoftAP scripts (needed before setup_script runs)
      mkdir -p scripts/softap
      curl -fsSL "$REPO_URL/scripts/softap/setup-softap.sh" -o scripts/softap/setup-softap.sh || {
          log "Warning: Failed to download setup-softap.sh"
      }
      curl -fsSL "$REPO_URL/scripts/softap/auto-ap.sh" -o scripts/softap/auto-ap.sh || {
          log "Warning: Failed to download auto-ap.sh"
      }
      curl -fsSL "$REPO_URL/scripts/softap/wifi-setup-server.js" -o scripts/softap/wifi-setup-server.js || {
          log "Warning: Failed to download wifi-setup-server.js"
      }
      curl -fsSL "$REPO_URL/scripts/softap/cbridge-setup-ap.service" -o scripts/softap/cbridge-setup-ap.service || {
          log "Warning: Failed to download cbridge-setup-ap.service"
      }
      chmod +x scripts/softap/*.sh 2>/dev/null || true

      # Create minimal directory structure (setup_script expects backend/)
      mkdir -p backend frontend

      log "Running setup script from repository directory..."
      log "Note: This may take 15-30 minutes depending on internet speed"
      
      # Run setup script (don't exit on failure - allow SoftAP to start)
      if sudo ./setup_script; then
          log "Setup script completed successfully"
      else
          log "WARNING: Setup script encountered errors"
          log "Some features may not be available, but SoftAP will still work"
          log "Check logs and retry setup_script manually if needed"
      fi

      touch "$STATE_FILE"

      log "First boot setup completed successfully!"
      log "Note: setup_script has installed SoftAP and auto-ap service"
      log "Auto-ap service will automatically start SoftAP if WiFi is not configured"
      log "Connect to 'CBridge-Setup' network and visit http://192.168.4.1:8080 to configure WiFi"

  # Systemd service
  - path: /etc/systemd/system/cbridge-first-boot.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=C-Bridge First Boot Automated Setup
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/cbridge-first-boot.sh
      RemainAfterExit=yes
      StandardOutput=journal
      StandardError=journal
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target

# -----------------------------
# First boot commands
# -----------------------------
runcmd:
  - systemctl daemon-reexec
  - systemctl daemon-reload
  - systemctl enable cbridge-first-boot.service
  - systemctl start cbridge-first-boot.service
  - timedatectl set-timezone Asia/Kolkata
  - systemctl enable ssh
  - systemctl start ssh

# -----------------------------
# Final message
# -----------------------------
final_message: |
  C-Bridge First Boot Setup Complete!

  Check logs:
  /var/log/cbridge-first-boot.log

  State file:
  /var/lib/cbridge/first-boot-complete

  If WiFi is not configured,
  connect to "CBridge-Setup"
  and open:

  http://192.168.4.1:8080
